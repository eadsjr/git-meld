#!/bin/bash
# This command restores a previously hidden branch

# Copyright 2015 by Jason Randolph Eads <jeads442@gmail.com>
# Licensed under the Apache License, Version 2.0 (the "License");
#     http://www.apache.org/licenses/LICENSE-2.0

declare -a errorcodes
errorcodes["usage_error"]=3
errorcodes["missing_target"]=4
errorcodes["update_ref_failed_EC"]=6
errorcodes["update_ref_failed_no_EC"]=7
errorcodes["delete_failed"]=8
errorcodes["none_hidden"]=10
errorcodes["duplicate_branch"]=11

if [ $# -ne 1 ] ; then
	>&2 echo "usage: git unhide branch-to-unhide"
	>&2 echo "This command restores a previously hidden branch"
	>&2 echo "Try 'git hidden' to see the names of hidden branches."
	exit ${errorcodes["usage_error"]}
fi

branch=$1
hidden_dir=$(git rev-parse --show-toplevel)/.git/refs/hidden/
heads_dir=$(git rev-parse --show-toplevel)/.git/refs/heads/
if [ ! -e $hidden_dir ] ; then
	>&2 echo "ERROR: no hidden branches found"
	exit ${errorcodes["none_hidden"]}
fi
if [ ! -e $hidden_dir$branch ] ; then
	>&2 echo "ERROR: branch \""$branch"\" not found in hidden folder"
	exit ${errorcodes["missing_target"]}
fi
if [ -e $heads_dir$branch ] ; then
	>&2 echo "ERROR: there is already an active branch with the name \""$branch"\" !"
	exit ${errorcodes["duplicate_branch"]}
fi

git update-ref refs/heads/$branch refs/hidden/$branch
if [ $? -ne 0 ] ; then
	>&2 echo "ERROR on update-ref: aborting unhide command for \""$branch"\""
	exit ${errorcodes["update_ref_failed_EC"]}
fi

if [ ! -e $heads_dir$branch ] ; then
	>&2 echo "ERROR: active branch ref not found after update-ref, aborting unhide command for \""$branch"\""
	exit ${errorcodes["update_ref_failed_no_EC"]}
fi

rm $hidden_dir$branch
if [ $? -ne 0 ] ; then
	>&2 echo "ERROR: failed to delete hidden reference for \""$branch"\""
	exit ${errorcodes["delete_failed"]}
else
	# clean up any unused hidden folders
	folders=hidden/$branch
	while [ $(dirname $folders) != '.' ] ; do
		folders=$(dirname $folders)
		rmdir $(git rev-parse --show-toplevel)/.git/refs/$folders > /dev/null 2> /dev/null
		if [ $? -ne 0 ] ; then
			break
		fi
	done
fi
